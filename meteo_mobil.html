<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√©t√©o Wind Surf Pro Mobile</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --blue: #007bff; --low: #d4edda; --med: #fff3cd; --high: #f8d7da; }
        body { font-family: system-ui, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; overflow-x: hidden; }
        .content { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 10px; width: 100%; box-sizing: border-box; }
        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; width: 100%; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 10px; min-width: 850px; }
		.param {display:flex;flex-direction:column;}
        th, td { border: 1px solid #eee; padding: 6px; text-align: center; }
        th:first-child, td:first-child { position: sticky; left: 0; z-index: 10; background: #fff; width: 80px; border-right: 2px solid #ddd; font-weight: bold; }
        
        /* Indicateurs de couleurs pour les rafales */
        .low { background: var(--low) !important; } 
        .med { background: var(--med) !important; } 
        .high { background: var(--high) !important; }

        .draggable { background: #f9f9f9; padding: 10px; margin: 5px 0; border-radius: 8px; display: flex; align-items: center; gap: 8px; width: 100%; box-sizing: border-box; flex-wrap: wrap; }
        .drag-handle { cursor: move; padding: 10px; background: #eee; border-radius: 4px; }
        .btn { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; font-size: 14px; }
        .btn-blue { background: var(--blue); color: white; }
        .hidden { display: none; }
        #map { height: 400px; border-radius: 8px; margin-top: 10px; width: 100%; }
    </style>
</head>
<body>
    <div style="display: flex; gap: 8px; width: 100%; box-sizing: border-box;">
        <button class="btn btn-blue" style="flex:1" onclick="showTab('forecast')">üìä M√©t√©o</button>
        <button class="btn" style="flex:1; background:#28a745; color:white;" onclick="showTab('mapTab')">üó∫Ô∏è Carte</button>
        <button class="btn" style="flex:1; background:#6c757d; color:white;" onclick="showTab('settings')">‚öôÔ∏è Lieux</button>
    </div>

    <div id="forecast" class="content"><div id="tableContainer">Chargement...</div></div>
    <div id="mapTab" class="content hidden"><div id="map"></div></div>
    <div id="settings" class="content hidden">
        <div id="sortableList"></div>
        <button class="btn" onclick="addLoc()" style="background:#e9ecef;">+ Ajouter un spot</button>
        <button class="btn btn-blue" onclick="save()">üíæ Enregistrer</button>
        <button class="btn" onclick="resetLocs()" style="background:#dc3545; color:white;">üîÑ Reset</button>
    </div>

    <script>
        let map;
        const defaultLocs = [{ name: "Cap d'Agde", lat: 43.2743, lon: 3.5002 }, { name: "Gruissan", lat: 43.0917, lon: 3.1067 }, { name: "La Franqui", lat: 42.9322, lon: 3.0385 }, { name: "P. Nouvelle", lat: 43.0315, lon: 3.0679 }, { name: "Leucate", lat: 42.8975, lon: 3.0528 }, { name: "Le Barcar√®s", lat: 42.8006, lon: 3.0390 }, { name: "Ste-Marie", lat: 42.7271, lon: 3.0389 }, { name: "Canet", lat: 42.6612, lon: 3.0336 }];
        let locs = JSON.parse(localStorage.getItem('wind_v8')) || defaultLocs;

        const getColor = (s) => s < 15 ? 'low' : (s < 25 ? 'med' : 'high');

        async function load() {
            const container = document.getElementById('tableContainer');
            container.innerHTML = "Mise √† jour...";
            let html = "";
            for (let d = 0; d < 3; d++) {
                html += `<h3>üìÖ ${["Aujourd'hui","Demain","J+2"][d]}</h3><div class="table-wrapper"><table><tr><th>Lieu</th>`;
                for(let h=8; h<=20; h++) html += `<th>${h}h</th>`;
                html += '</tr>';
                for (let l of locs) {
                    try {
                        const [resM, resW] = await Promise.all([
                            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${l.lat}&longitude=${l.lon}&hourly=temperature_2m,precipitation,cloud_cover,wind_speed_10m,wind_gusts_10m,wind_direction_10m&wind_speed_unit=kn&forecast_days=3`),
                            fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${l.lat}&longitude=${l.lon}&hourly=wave_height&forecast_days=3`)
                        ]);
                        const data = await resM.json();
                        const wData = await resW.json();
                        html += `<tr><td style="font-size:1.8em">${l.name}</td>`;
                        for(let i = d*24 + 8; i <= d*24 + 20; i++) {
                            const s = Math.round(data.hourly.wind_speed_10m[i]);
                            const g = Math.round(data.hourly.wind_gusts_10m[i]);
                            const p = data.hourly.precipitation[i];
                            const c = data.hourly.cloud_cover[i];
                            const wave = (wData.hourly && wData.hourly.wave_height) ? wData.hourly.wave_height[i] : 0;
                            let ico = c < 20 ? "‚òÄÔ∏è" : (c < 50 ? "üå§Ô∏è" : "‚òÅÔ∏è");
                            if (p > 0.1) ico = "‚õàÔ∏è"; //

                            const temp = Math.round(data.hourly.temperature_2m[i]); // R√©cup√©ration de la temp√©rature

							html += `<td class="${getColor(g)}">
								<div class="param">
									<span style="font-size:1.2em; color:#555;">üå°Ô∏è${temp}¬∞</span>
									<span style="font-size:1.4em">${ico}</span>
									<span style="font-size:1.8em;display:block;margin:5px 0;"><b>${s}</b> <small>(${g})</small></span>
									<div style="display:inline-block;transform:rotate(${data.hourly.wind_direction_10m[i] + 180}deg); font-size:2em;">‚Üë</div>
									<span style="font-size:0.8em">üåä ${wave}m</span>
								</div>
							</td>`;
                        }
                        html += '</tr>';
                    } catch(e) { console.error(e); }
                }
                html += '</table></div>';
            }
            container.innerHTML = html;
        }

        function showTab(t) { 
            ['forecast', 'settings', 'mapTab'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(t).classList.remove('hidden');
			if (t === 'mapTab') setTimeout(() => { 
    if (!map) { 
        map = L.map('map').setView([locs[0].lat, locs[0].lon], 8); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); 
        locs.forEach(l => L.marker([l.lat, l.lon]).addTo(map).bindPopup(l.name));

        // AJOUT : Capture du clic et copie
        map.on('click', function(e) {
            const coords = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
            navigator.clipboard.writeText(coords).then(() => {
                L.popup()
                    .setLatLng(e.latlng)
                    .setContent("Copi√© : " + coords)
                    .openOn(map);
            });
        });
    } 
}, 200);
        }

        function renderSettings() {
            document.getElementById('sortableList').innerHTML = locs.map((l, i) => `<div class="draggable"><span class="drag-handle">‚ò∞</span><input class="name-in" value="${l.name}" style="flex:2; min-width:80px"><input class="lat-in" value="${l.lat}" style="flex:1; min-width:50px"><input class="lon-in" value="${l.lon}" style="flex:1; min-width:50px"><button onclick="removeLoc(${i})" style="color:red; border:none; background:none">‚úï</button></div>`).join('');
            new Sortable(document.getElementById('sortableList'), { handle: '.drag-handle', animation: 150, forceFallback: true });
        }

        function addLoc() { locs.push({name:"", lat:0, lon:0}); renderSettings(); }
        function removeLoc(i) { locs.splice(i, 1); renderSettings(); }
        function save() { 
            const draggables = document.querySelectorAll('.draggable');
            locs = Array.from(draggables).map(d => ({ name: d.querySelector('.name-in').value, lat: parseFloat(d.querySelector('.lat-in').value), lon: parseFloat(d.querySelector('.lon-in').value) }));
            localStorage.setItem('wind_v8', JSON.stringify(locs)); load(); showTab('forecast'); 
        }
        function resetLocs() { if (confirm("R√©initialiser ?")) { localStorage.removeItem('wind_v8'); location.reload(); } }
        renderSettings(); load();
    </script>
</body>
</html>