<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>La m√©t√©o de vos spots</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js?v=2.5').then(reg => {
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed') {
                            if (navigator.serviceWorker.controller) {
                                // Une nouvelle version est disponible
                                if (confirm("Nouvelle version disponible ! Voulez-vous mettre √† jour ?")) {
                                    window.location.reload();
                                }
                            }
                        }
                    };
                };
            });
        }
    </script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #007AFF;
            --secondary: #5856D6;
            --success: #34C759;
            --danger: #FF3B30;
            --warning: #FF9500;
            --gray: #8E8E93;
            --bg-body: #F2F2F7;
            --bg-card: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #3C3C43;
            --border: #E5E5EA;

            --wind-low-bg: #E8F5E9;
            --wind-low-text: #1B5E20;
            --wind-med-bg: #FFF3E0;
            --wind-med-text: #E65100;
            --wind-high-bg: #FFEBEE;
            --wind-high-text: #B71C1C;
            --wind-vhigh-bg: #F3E5F5;
            --wind-vhigh-text: #4A148C;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 12px;
            -webkit-tap-highlight-color: transparent;
        }

        /* Navigation */
        .nav-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            background: var(--bg-card);
            padding: 8px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .btn-nav {
            border: none;
            background: rgba(118, 118, 128, 0.08);
            /* Light gray fill */
            color: var(--text-sub);
            padding: 10px 4px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .btn-nav span.icon {
            font-size: 18px;
            display: block;
            margin-bottom: 2px;
        }

        .btn-nav.active,
        .btn-nav:active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25);
        }

        /* Custom Colors for Tabs to match original intent but modernized */
        .btn-nav[onclick*="map"] {
            color: var(--success);
            background: rgba(52, 199, 89, 0.1);
        }

        .btn-nav[onclick*="map"]:active,
        .btn-nav[onclick*="map"].active {
            background: var(--success);
            color: white;
        }

        .btn-nav[onclick*="settings"] {
            color: var(--gray);
            background: rgba(142, 142, 147, 0.1);
        }

        .btn-nav[onclick*="settings"]:active,
        .btn-nav[onclick*="settings"].active {
            background: var(--gray);
            color: white;
        }

        .btn-nav[onclick*="help"] {
            color: #5856D6;
            background: rgba(88, 86, 214, 0.1);
        }

        .btn-nav[onclick*="help"]:active,
        .btn-nav[onclick*="help"].active {
            background: #5856D6;
            color: white;
        }

        /* Main Content */
        .content {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden {
            display: none !important;
        }

        /* View Selector */
        .view-selector {
            display: inline-flex;
            background: rgba(118, 118, 128, 0.12);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 20px;
            position: relative;
        }

        .view-selector button {
            border: none;
            padding: 8px 16px;
            border-radius: 9px;
            cursor: pointer;
            background: transparent;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-sub);
            transition: all 0.2s;
        }

        .view-selector button.active {
            background: white;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.12);
            color: var(--text-main);
            font-weight: 600;
        }

        /* Tables */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 24px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: #fff;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            min-width: 800px;
        }

        th,
        td {
            padding: 10px 8px;
            text-align: center;
            border-bottom: 1px solid #D1D1D6;
            /* Thinner gray line */
            border-right: 1px dashed var(--border);
        }

        th {
            background: #F9F9F9;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-sub);
            font-weight: 600;
            padding-top: 14px;
            padding-bottom: 14px;
        }

        th:last-child,
        td:last-child {
            border-right: none;
        }

        tr:last-child td {
            border-bottom: none;
        }

        th:first-child,
        td:first-child {
            position: sticky;
            left: 0;
            z-index: 10;
            background: white;
            border-right: 2px solid var(--border);
            width: 90px;
            font-weight: 700;
            color: var(--primary);
            box-shadow: 4px 0 8px rgba(0, 0, 0, 0.02);
        }

        .param-cell {
            display: flex;
            flex-direction: column;
            gap: 3px;
            align-items: center;
            justify-content: center;
            min-height: 50px;
        }

        /* Wind Cells */
        .low {
            background: var(--wind-low-bg) !important;
            color: var(--wind-low-text);
        }

        .med {
            background: var(--wind-med-bg) !important;
            color: var(--wind-med-text);
        }

        .high {
            background: var(--wind-high-bg) !important;
            color: var(--wind-high-text);
            font-weight: bold;
        }

        .vhigh {
            background: var(--wind-vhigh-bg) !important;
            color: var(--wind-vhigh-text);
            font-weight: 900;
        }

        /* Map */
        #map {
            height: 60vh;
            width: 100%;
            border-radius: 16px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.1);
        }

        /* Settings */
        .draggable {
            background: #fff;
            padding: 14px;
            margin: 10px 0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }

        .drag-handle {
            cursor: grab;
            color: #BBB;
            font-size: 20px;
            padding: 4px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        input[type="text"],
        input[type="number"],
        .name-in,
        .lat-in,
        .lon-in {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #CCC;
            font-size: 14px;
            background: #F9F9F9;
        }

        .name-in {
            font-weight: 600;
            color: var(--text-main);
        }

        .btn {
            padding: 14px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-bottom: 12px;
            font-size: 15px;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-blue {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        hr {
            border: 0;
            border-top: 1px dashed #DDD;
            margin: 30px 0;
        }

        h3 {
            margin-top: 0;
            color: var(--text-main);
            font-size: 1.2rem;
        }
    </style>
</head>

<body>
    <div class="nav-bar">
        <!-- Using unified class structure, keeping onclick functionality -->
        <button class="btn-nav active" onclick="showTab('forecast'); setActive(this)">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2v2" />
                <path d="m4.93 4.93 1.41 1.41" />
                <path d="M20 12h2" />
                <path d="m19.07 4.93-1.41 1.41" />
                <path d="M15.947 12.65a4 4 0 0 0-5.925-4.128" />
                <path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z" />
            </svg>
            M√©t√©o
        </button>
        <button class="btn-nav" onclick="showTab('mapTab'); setActive(this)">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 22V6l-6-2v14l6 2zM15 2v14l6 2V4l-6-2zM9 6l6-4" />
                <path d="M9 22l6-4" />
            </svg>
            Carte
        </button>
        <button class="btn-nav" onclick="showTab('settings'); setActive(this)">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path
                    d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                <circle cx="12" cy="12" r="3" />
            </svg>
            Param.
        </button>
        <button class="btn-nav" onclick="showTab('help'); setActive(this)">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10" />
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                <path d="M12 17h.01" />
            </svg>
            Aide
        </button>
    </div>

    <div id="forecast" class="content">
        <div class="view-selector">
            <button id="viewDay" class="active" onclick="setViewMode('day')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="vertical-align:middle;margin-right:4px">
                    <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
                    <line x1="16" x2="16" y1="2" y2="6" />
                    <line x1="8" x2="8" y1="2" y2="6" />
                    <line x1="3" x2="21" y1="10" y2="10" />
                </svg>Par Jour
            </button>
            <button id="viewLoc" onclick="setViewMode('loc')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="vertical-align:middle;margin-right:4px">
                    <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" />
                    <circle cx="12" cy="10" r="3" />
                </svg>Par Lieu
            </button>
        </div>
        <div id="tableContainer" style="color:var(--gray); text-align:center; padding:40px;">Chargement des
            pr√©visions...</div>
    </div>

    <div id="mapTab" class="content hidden" style="padding:0; overflow:hidden;">
        <div id="map" style="height: 500px; border-radius: 16px;"></div>
    </div>

    <div id="settings" class="content hidden">
        <h3><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                style="vertical-align:middle">
                <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" />
                <circle cx="12" cy="10" r="3" />
            </svg> Mes Spots</h3>
        <p style="font-size:0.9em; color:#888; margin-bottom:15px;">Glissez pour r√©organiser</p>
        <div id="sortableLocs"></div>
        <button class="btn" onclick="addLoc()" style="background:#F2F2F7; color:var(--primary); margin-top:10px;">+
            Ajouter un spot vide</button>
        <hr>
        <h3><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                style="vertical-align:middle">
                <path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" />
                <path d="M12 12v9" />
                <path d="m8 17 4 4 4-4" />
            </svg> Affichage</h3>
        <div id="sortableParams"></div>
        <hr>
        <div class="settings-group" style="background:#F9F9F9; padding:15px; border-radius:12px;">
            <label for="daysCount" style="display:flex; justify-content:space-between; align-items:center;">
                <span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="vertical-align:middle;margin-right:4px">
                        <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
                        <line x1="16" x2="16" y1="2" y2="6" />
                        <line x1="8" x2="8" y1="2" y2="6" />
                        <line x1="3" x2="21" y1="10" y2="10" />
                    </svg> Jours de pr√©visions</span>
                <input type="number" id="daysCount" min="1" max="15"
                    style="width: 60px; text-align:center; font-weight:bold;">
            </label>
        </div>
        <br>
        <button class="btn btn-blue" onclick="save()">üíæ Enregistrer les modifications</button>
        <button class="btn" onclick="resetAll()" style="background:#FF3B30; color:white; opacity:0.8;">üö® R√©initialiser
            tout</button>
    </div>

    <div id="help" class="content hidden">
        <h3><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                style="vertical-align:middle">
                <circle cx="12" cy="12" r="10" />
                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                <path d="M12 17h.01" />
            </svg> Aide & Fonctionnement</h3>
        <p>Cette application affiche les pr√©visions m√©t√©o et marines pour vos spots de glisse.</p>
        <p>Elle s'installe sur les syst√®mes Android comme une application web (PWA).</p>
        <p>Son int√©r√™t consiste √† pouvoir comparer rapidement sur une page les conditions m√©t√©o entre plusieurs spots de
            glisse et de choisir les informations qui sont importantes pour vous.
            <br>Les codes couleurs indiquent la force du vent en rafales :
        </p>
        <ul>
            <li><strong style="color:green;">Vert</strong> : faible (moins de 15 n≈ìuds)</li>
            <li><strong style="color:orange;">Orange</strong> : mod√©r√© (15 √† 25 n≈ìuds)</li>
            <li><strong style="color:red;">Rouge</strong> : fort (25 √† 34 n≈ìuds)</li>
            <li><strong style="color:purple;">Violet</strong> : tr√®s fort (35 n≈ìuds et plus)</li>
        </ul>

        <h4>M√©t√©o :</h4>
        <p>Visualisez le vent (rafales), la temp√©rature et les vagues.</p>
        <h4>Carte :</h4>
        <p>Cliquez sur la carte pour ajouter un nouveau spot instantan√©ment.
            Les coordonn√©es de l'endroit cliqu√© seront rajout√©es √† votre liste de spots.
            Il suffit ensuite de retourner dans les param√®tres pour renommer le spot que vous venez d'ajouter.
            N'oubliez pas de sauvegarder vos modifications en cliquant sur "Enregistrer".
        </p>
        <h4>Param√®tres :</h4>
        <ul>
            <li>R√©organisez les spots et param√®tres par glisser-d√©poser.
                Utilisez la carte pour ajouter rapidement de nouveaux spots.
            </li>
            <li>Activez/d√©sactivez les donn√©es (UV, Ressenti, P√©riode de vagues).
                Vous pouvez aussi choisir l'ordre d'affichage des param√®tres.
            </li>
            <li>Ajustez la dur√©e des pr√©visions (jusqu'√† 15 jours)
            </li>
            <li>Attention √† toujours cliquer sur "Enregistrer" pour que vos modifications soient prises en
                compte.
            </li>
            <li>Appuyer sur "Reset" pour r√©initialiser l'application et effacer toutes vos donn√©es sauvegard√©es.
                Les spots par d√©faut seront alors restaur√©s (ceux entre Agde et Canet en Roussillon).
            </li>

        </ul>
    </div>
    <script>
        let map, markersGroup;
        let clickCount = 1;
        let viewMode = localStorage.getItem('wind_view_mode') || 'day';
        let unsavedChanges = false;

        const defaultLocs = [{ name: "Cap d'Agde", lat: 43.2743, lon: 3.5002 }, { name: "Gruissan", lat: 43.0917, lon: 3.1067 }, { name: "P. Nouvelle", lat: 43.0315, lon: 3.0679 }, { name: "La Franqui", lat: 42.9322, lon: 3.0385 }, { name: "Leucate", lat: 42.8975, lon: 3.0528 }, { name: "Le Barcar√®s", lat: 42.8006, lon: 3.0390 }, { name: "Ste-Marie", lat: 42.7271, lon: 3.0389 }, { name: "Canet", lat: 42.6612, lon: 3.0336 }];

        const defaultParams = [
            { id: 'temp', label: 'Temp√©rature', active: true },
            { id: 'app_temp', label: 'Temp. ressentie', active: false },
            { id: 'uv', label: 'Indice UV', active: false },
            { id: 'ico', label: 'Ic√¥ne M√©t√©o', active: true },
            { id: 'wind', label: 'Vent (Rafales)', active: true },
            { id: 'dir', label: 'Direction', active: true },
            { id: 'wave', label: 'Haut. Vagues', active: true },
            { id: 'wave_per', label: 'P√©riode vagues', active: false },
            { id: 'wave_dir', label: 'Direction vagues', active: false }
        ];

        let locs = JSON.parse(localStorage.getItem('wind_locs')) || defaultLocs;
        let savedParams = JSON.parse(localStorage.getItem('wind_params')) || [];
        let forecastDays = parseInt(localStorage.getItem('wind_days')) || 3;
        let activeParams = defaultParams.map(defP => {
            const saved = savedParams.find(sP => sP.id === defP.id);
            return saved ? saved : defP;
        });

        const getColor = (s) => {
            if (s < 15) return 'low';
            if (s < 25) return 'med';
            if (s < 35) return 'high';
            return 'vhigh';
        };

        function getDayTitle(dayIndex) {
            const date = new Date();
            date.setDate(date.getDate() + dayIndex);
            if (dayIndex === 0) return "Aujourd'hui";
            if (dayIndex === 1) return "Demain";
            return date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric' });
        }

        function setViewMode(mode) {
            viewMode = mode;
            localStorage.setItem('wind_view_mode', mode);
            document.getElementById('viewDay').classList.toggle('active', mode === 'day');
            document.getElementById('viewLoc').classList.toggle('active', mode === 'loc');
            load();
        }

        /* Added simple Active State for Nav Buttons */
        function setActive(btn) {
            document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        async function fetchData(l) {
            const [resM, resW] = await Promise.all([
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${l.lat}&longitude=${l.lon}&hourly=temperature_2m,apparent_temperature,uv_index,precipitation,cloud_cover,wind_speed_10m,wind_gusts_10m,wind_direction_10m&wind_speed_unit=kn&forecast_days=${forecastDays}`),
                fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${l.lat}&longitude=${l.lon}&hourly=wave_height,wave_period,wave_direction&forecast_days=${forecastDays}`)
            ]);
            return { meteo: await resM.json(), marine: await resW.json() };
        }

        function renderCell(data, wData, index) {
            const svgIcon = "data:image/svg+xml;charset=utf-8,%3Csvg height='16' width='16' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23121212'%3E%3Cpath d='M2.833 1L8 4.333 13.167 1 8 16z' stroke='%23fff' stroke-width='2'/%3E%3Cpath d='M2.833 1L8 4.333 13.167 1 8 16z'/%3E%3C/g%3E%3C/svg%3E";
            const svgIconWave = "data:image/svg+xml;charset=utf-8,%3Csvg height='16' width='16' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23007bff'%3E%3Cpath d='M2.833 1L8 4.333 13.167 1 8 16z' stroke='%23fff' stroke-width='2'/%3E%3Cpath d='M2.833 1L8 4.333 13.167 1 8 16z'/%3E%3C/g%3E%3C/svg%3E";

            const gVal = data.wind_gusts_10m[index];
            const g = (gVal !== null && gVal !== undefined) ? Math.round(gVal) : 0;
            // Use neutral background if no wind data, otherwise standard colors
            const bgClass = (gVal !== null && gVal !== undefined) ? getColor(g) : '';

            let html = `<td class="${bgClass}"><div class="param-cell">`;

            const isValid = (val) => val !== null && val !== undefined;

            activeParams.forEach(p => {
                if (!p.active) return;

                if (p.id === 'temp' && isValid(data.temperature_2m[index]))
                    html += `<span style="color:var(--text-sub); font-size:0.9em;">üå°Ô∏è${Math.round(data.temperature_2m[index])}¬∞</span>`;

                if (p.id === 'app_temp' && isValid(data.apparent_temperature[index]))
                    html += `<span style="color:#999; font-size:0.75em;">(Ress. ${Math.round(data.apparent_temperature[index])}¬∞)</span>`;

                if (p.id === 'uv' && isValid(data.uv_index[index]))
                    html += `<span style="color:#FF9500; font-weight:700; font-size:0.75em;">UV ${data.uv_index[index]}</span>`;

                if (p.id === 'ico' && isValid(data.cloud_cover[index]) && isValid(data.precipitation[index])) {
                    let ico = data.cloud_cover[index] < 20 ? "‚òÄÔ∏è" : (data.cloud_cover[index] < 50 ? "üå§Ô∏è" : "‚òÅÔ∏è");
                    if (data.precipitation[index] > 0.1) ico = "‚õàÔ∏è";
                    html += `<span style="font-size:1.5em; margin:2px 0;">${ico}</span>`;
                }

                if (p.id === 'wind' && isValid(data.wind_speed_10m[index])) {
                    // Only show gust if valid
                    const gustStr = isValid(gVal) ? ` <small style="opacity:0.7">(${Math.round(gVal)})</small>` : '';
                    html += `<span style="font-size:1.2em"><b>${Math.round(data.wind_speed_10m[index])}</b>${gustStr}</span>`;
                }

                if (p.id === 'dir' && isValid(data.wind_direction_10m[index]))
                    html += `<div style="transform:rotate(${data.wind_direction_10m[index]}deg); margin:2px 0;"><img src="${svgIcon}" width="18" style="opacity:0.8"></div>`;

                if (p.id === 'wave' && wData.wave_height && isValid(wData.wave_height[index]))
                    html += `<span style="font-size:0.85em; color:#007AFF;">üåä ${wData.wave_height[index]}m</span>`;

                if (p.id === 'wave_per' && wData.wave_period && isValid(wData.wave_period[index]))
                    html += `<span style="font-size:0.85em; color:#5856D6;">‚è±Ô∏è ${wData.wave_period[index]}s</span>`;

                if (p.id === 'wave_dir' && wData.wave_direction && isValid(wData.wave_direction[index]))
                    html += `<div style="transform:rotate(${wData.wave_direction[index]}deg);color:blue;"><img src="${svgIconWave}" width="12"></div>`;
            });
            html += `</div></td>`;
            return html;
        }

        async function load() {
            const container = document.getElementById('tableContainer');
            // Simplified loading state

            const visibleLocs = locs.filter(l => l.visible !== false);
            const allData = {};
            for (let l of visibleLocs) {
                try { allData[l.name] = await fetchData(l); } catch (e) { console.error(e); }
            }

            let html = "";

            if (viewMode === 'day') {
                for (let d = 0; d < forecastDays; d++) {
                    html += `<h3><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>${getDayTitle(d)}</h3><div class="table-wrapper"><table><tr><th>Lieu</th>`;
                    for (let h = 8; h <= 20; h++) html += `<th>${h}h</th>`;
                    html += '</tr>';
                    for (let l of visibleLocs) {
                        const dL = allData[l.name];
                        if (!dL) continue;
                        html += `<tr><td style="font-size:1em">${l.name}</td>`;
                        for (let i = d * 24 + 8; i <= d * 24 + 20; i++) {
                            html += renderCell(dL.meteo.hourly, dL.marine.hourly, i);
                        }
                        html += '</tr>';
                    }
                    html += '</table></div>';
                }
            } else {
                for (let l of visibleLocs) {
                    const dL = allData[l.name];
                    if (!dL) continue;
                    html += `<h3><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:6px"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>${l.name}</h3><div class="table-wrapper"><table><tr><th>Jour</th>`;
                    for (let h = 8; h <= 20; h++) html += `<th>${h}h</th>`;
                    html += '</tr>';
                    for (let d = 0; d < forecastDays; d++) {
                        html += `<tr><td style="font-size:0.95em">${getDayTitle(d)}</td>`;
                        for (let i = d * 24 + 8; i <= d * 24 + 20; i++) {
                            html += renderCell(dL.meteo.hourly, dL.marine.hourly, i);
                        }
                        html += '</tr>';
                    }
                    html += '</table></div>';
                }
            }
            container.innerHTML = html;
        }

        function showTab(t) {
            // Check for unsaved changes when leaving settings
            const settingsTab = document.getElementById('settings');
            if (t !== 'settings' && !settingsTab.classList.contains('hidden') && unsavedChanges) {
                if (confirm("Vous avez des modifications non enregistr√©es. Voulez-vous les sauvegarder avant de quitter ?")) {
                    save(false); // Save without redirecting, as we are navigating anyway
                }
                unsavedChanges = false;
            }

            ['forecast', 'settings', 'mapTab', 'help'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(t).classList.remove('hidden');
            if (t === 'settings') {
                renderSettings();
                unsavedChanges = false; // Reset when entering settings fresh
            }
            if (t === 'mapTab') setTimeout(() => initMap(), 200);
            if (t === 'forecast') {
                document.getElementById('viewDay').classList.toggle('active', viewMode === 'day');
                document.getElementById('viewLoc').classList.toggle('active', viewMode === 'loc');
            }
        }

        function initMap() {
            if (!map) {
                map = L.map('map').setView([43.1, 3.1], 8);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                markersGroup = L.layerGroup().addTo(map);
                refreshMarkers();
                map.on('click', function (e) {
                    const newName = `Spot ${clickCount++}`;
                    const newLoc = { name: newName, lat: parseFloat(e.latlng.lat.toFixed(4)), lon: parseFloat(e.latlng.lng.toFixed(4)) };
                    locs.push(newLoc);
                    refreshMarkers();
                    L.popup().setLatLng(e.latlng).setContent(newName).openOn(map);
                });
            } else { refreshMarkers(); }
        }

        function refreshMarkers() {
            if (!markersGroup) return;
            markersGroup.clearLayers();
            locs.forEach(l => {
                if (l.lat && l.lon) {
                    L.marker([l.lat, l.lon]).addTo(markersGroup).bindPopup(l.name);
                }
            });
        }

        function renderSettings() {
            document.getElementById('daysCount').value = forecastDays;
            document.getElementById('daysCount').onchange = () => unsavedChanges = true;
            document.getElementById('sortableLocs').innerHTML = locs.map((l, i) => `
                <div class="draggable loc-item">
                    <span class="drag-handle">‚ò∞</span>
                    <input type="checkbox" class="loc-visible" ${l.visible !== false ? 'checked' : ''} title="Afficher/Masquer">
                    <input class="name-in" value="${l.name}" style="flex:2; width:80px" placeholder="Nom">
                    <span style="font-size:10px; color:#aaa; display:flex; flex-direction:column;">
                       <span>${l.lat}</span><span>${l.lon}</span>
                    </span>
                    <input type="hidden" class="lat-in" value="${l.lat}">
                    <input type="hidden" class="lon-in" value="${l.lon}">
                    <button onclick="removeLoc(${i})" style="color:var(--danger); border:none; background:none; font-weight:bold;">‚úï</button>
                </div>`).join('');

            document.getElementById('sortableParams').innerHTML = activeParams.map((p) => `
                <div class="draggable param-item" data-id="${p.id}">
                    <span class="drag-handle">‚ò∞</span>
                    <input type="checkbox" ${p.active ? 'checked' : ''} class="param-check">
                    <span class="param-label" style="flex:1; font-weight:500;">${p.label}</span>
                </div>`).join('');

            // Attach listeners to detect changes
            document.querySelectorAll('.loc-visible, .name-in, .param-check').forEach(el => {
                el.addEventListener('change', () => unsavedChanges = true);
                el.addEventListener('input', () => unsavedChanges = true);
            });

            const sortOptions = {
                handle: '.drag-handle',
                animation: 150,
                delay: 100,
                delayOnTouchOnly: true,
                touchStartThreshold: 5,
                onEnd: () => unsavedChanges = true
            };

            new Sortable(document.getElementById('sortableLocs'), sortOptions);
            new Sortable(document.getElementById('sortableParams'), sortOptions);
        }

        function addLoc() { locs.push({ name: "Nouveau Spot", lat: 43.0, lon: 3.0 }); renderSettings(); unsavedChanges = true; }
        function removeLoc(i) { locs.splice(i, 1); renderSettings(); unsavedChanges = true; }

        function save(redirect = true) {
            let dInput = parseInt(document.getElementById('daysCount').value);
            forecastDays = Math.min(Math.max(dInput, 1), 15);
            localStorage.setItem('wind_days', forecastDays);

            const locElems = document.querySelectorAll('.loc-item');
            locs = Array.from(locElems).map(el => ({
                visible: el.querySelector('.loc-visible').checked,
                name: el.querySelector('.name-in').value,
                lat: parseFloat(el.querySelector('.lat-in').value),
                lon: parseFloat(el.querySelector('.lon-in').value)
            }));

            const paramElems = document.querySelectorAll('.param-item');
            activeParams = Array.from(paramElems).map(el => ({
                id: el.dataset.id,
                label: el.querySelector('.param-label').innerText,
                active: el.querySelector('.param-check').checked
            }));

            localStorage.setItem('wind_locs', JSON.stringify(locs));
            localStorage.setItem('wind_params', JSON.stringify(activeParams));

            unsavedChanges = false; // Reset flag after save

            refreshMarkers();
            load();
            if (redirect) showTab('forecast');
        }

        function resetAll() { if (confirm("Ceci effacera tous vos spots favoris. Continuer ?")) { localStorage.clear(); location.reload(); } }

        // Initialisation
        // Restore active tab logic if needed, but default to forecast is fine.
        // Also ensure unified nav state matches
        load();
    </script>
</body>

</html>